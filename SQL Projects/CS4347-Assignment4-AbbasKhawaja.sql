CREATE DATABASE Company
GO

USE Company
GO

CREATE SCHEMA company
GO

CREATE TABLE company.DEPARTMENT
(
	Dname VARCHAR(50) NOT NULL,
	Dnumber INT PRIMARY KEY NOT NULL,
	Mgr_ssn INT NOT NULL,
	Mgr_start_date DATE NOT NULL
)

CREATE TABLE company.DEPT_LOCATIONS
(
	Dnumber INT FOREIGN KEY REFERENCES company.DEPARTMENT(Dnumber) NOT NULL,
	Dlocation VARCHAR(50) NOT NULL,
	PRIMARY KEY(Dnumber, Dlocation)
)

CREATE TABLE company.PROJECT
(
	Pname VARCHAR(50) NOT NULL,
	Pnumber INT PRIMARY KEY NOT NULL,
	Plocation VARCHAR(50) NOT NULL,
	Dnum INT FOREIGN KEY REFERENCES company.DEPARTMENT(Dnumber) NOT NULL
)

CREATE TABLE company.EMPLOYEE
(
	Fname VARCHAR(50) NOT NULL,
	Minit VARCHAR(1) NOT NULL,
	Lname VARCHAR(50) NOT NULL,
	Ssn INT PRIMARY KEY NOT NULL,
	Bdate DATE NOT NULL,
	[Address] VARCHAR(100) NOT NULL,
	Sex VARCHAR(1) NOT NULL,
	Salary INT NOT NULL,
	Super_ssn INT FOREIGN KEY REFERENCES company.EMPLOYEE(Ssn),
	Dno INT FOREIGN KEY REFERENCES company.DEPARTMENT(Dnumber) NOT NULL
)

ALTER TABLE company.DEPARTMENT
ADD FOREIGN KEY (Mgr_ssn) REFERENCES company.EMPLOYEE(Ssn)

CREATE TABLE company.WORKS_ON
(
	Essn INT FOREIGN KEY REFERENCES company.EMPLOYEE(Ssn) NOT NULL,
	Pno INT FOREIGN KEY REFERENCES company.PROJECT(Pnumber) NOT NULL,
	[Hours] REAL,
	PRIMARY KEY(Essn, Pno)
)

CREATE TABLE company.[DEPENDENT]
(
	Essn INT FOREIGN KEY REFERENCES company.EMPLOYEE(Ssn) NOT NULL,
	Dependent_name VARCHAR(50) NOT NULL,
	Sex VARCHAR(1) NOT NULL,
	Bdate Date NOT NULL,
	Relationship VARCHAR(20)
)

ALTER TABLE company.DEPARTMENT
ALTER COLUMN Mgr_ssn INT NULL

INSERT INTO company.DEPARTMENT VALUES('Research', 5, NULL, '1988-05-22')
INSERT INTO company.DEPARTMENT VALUES('Administration', 4, NULL, '1995-01-01')
INSERT INTO company.DEPARTMENT VALUES('Headquarters', 1, NULL, '1981-06-19')

INSERT INTO company.EMPLOYEE VALUES('John', 'B', 'Smith', 123456789, '1965-01-09', '731 Fondren, Houston, TX', 'M', 30000, NULL, 5)
INSERT INTO company.EMPLOYEE VALUES('Franklin', 'T', 'Wong', 333445555, '1955-12-08', '638 Voss, Houston, TX', 'M', 40000, NULL, 5)
INSERT INTO company.EMPLOYEE VALUES('Alicia', 'J', 'Zelaya', 999887777, '1968-01-19', '3321 Castle, Spring, TX', 'F', 25000, NULL, 4)
INSERT INTO company.EMPLOYEE VALUES('Jennifer', 'S', 'Wallace', 987654321, '1941-06-20', '291 Berry, Bellaire, TX', 'F', 43000, NULL, 4)
INSERT INTO company.EMPLOYEE VALUES('Ramesh', 'K', 'Narayan', 666884444, '1962-09-15', '975 Fire Oak, Humble, TX', 'M', 38000, 333445555, 5)
INSERT INTO company.EMPLOYEE VALUES('Joyce', 'A', 'English', 453453453, '1972-07-31', '5631 Rice, Houston, TX', 'F', 25000, 333445555, 5)
INSERT INTO company.EMPLOYEE VALUES('Ahmad', 'V', 'Jabbar', 987987987, '1969-03-29', '980 Dallas, Houston, TX', 'M', 25000, 987654321, 4)
INSERT INTO company.EMPLOYEE VALUES('James', 'E', 'Borg', 888665555, '1937-11-10', '450 Stone, Houston, TX', 'M', 55000, NULL, 1)

UPDATE company.EMPLOYEE
SET Super_ssn = 333445555
WHERE Ssn = 123456789

UPDATE company.EMPLOYEE
SET Super_ssn = 888665555
WHERE Ssn = 333445555 OR Ssn = 987654321

UPDATE company.EMPLOYEE
SET Super_ssn = 987654321
WHERE Ssn = 999887777

UPDATE company.DEPARTMENT
SET Mgr_ssn = 333445555
WHERE Dnumber = 5

UPDATE company.DEPARTMENT
SET Mgr_ssn = 987654321
WHERE Dnumber = 4

UPDATE company.DEPARTMENT
SET Mgr_ssn = 888665555
WHERE Dnumber = 1

ALTER TABLE company.DEPARTMENT
ALTER COLUMN Mgr_ssn INT NOT NULL

INSERT INTO company.DEPT_LOCATIONS VALUES(1, 'Houston')
INSERT INTO company.DEPT_LOCATIONS VALUES(4, 'Stafford')
INSERT INTO company.DEPT_LOCATIONS VALUES(5, 'Bellaire')
INSERT INTO company.DEPT_LOCATIONS VALUES(5, 'Sugarland')
INSERT INTO company.DEPT_LOCATIONS VALUES(5, 'Houston')

INSERT INTO company.PROJECT VALUES('ProductX', 1, 'Bellaire', 5)
INSERT INTO company.PROJECT VALUES('ProductY', 2, 'Sugarland', 5)
INSERT INTO company.PROJECT VALUES('ProductZ', 3, 'Houston', 5)
INSERT INTO company.PROJECT VALUES('Computerization', 10, 'Stafford', 4)
INSERT INTO company.PROJECT VALUES('Reorganization', 20, 'Houston', 1)
INSERT INTO company.PROJECT VALUES('Newbenefits', 30, 'Stafford', 4)

INSERT INTO company.WORKS_ON VALUES(123456789, 1, 32.5)
INSERT INTO company.WORKS_ON VALUES(123456789, 2, 7.5)
INSERT INTO company.WORKS_ON VALUES(666884444, 3, 40.0)
INSERT INTO company.WORKS_ON VALUES(453453453, 1, 20.0)
INSERT INTO company.WORKS_ON VALUES(453453453, 2, 20.0)
INSERT INTO company.WORKS_ON VALUES(333445555, 2, 10.0)
INSERT INTO company.WORKS_ON VALUES(333445555, 3, 10.0)
INSERT INTO company.WORKS_ON VALUES(333445555, 10, 10.0)
INSERT INTO company.WORKS_ON VALUES(333445555, 20, 10.0)
INSERT INTO company.WORKS_ON VALUES(999887777, 30, 30.0)
INSERT INTO company.WORKS_ON VALUES(999887777, 10, 10.0)
INSERT INTO company.WORKS_ON VALUES(987987987, 10, 35.0)
INSERT INTO company.WORKS_ON VALUES(987987987, 30, 5.0)
INSERT INTO company.WORKS_ON VALUES(987654321, 30, 20.0)
INSERT INTO company.WORKS_ON VALUES(987654321, 20, 15.0)
INSERT INTO company.WORKS_ON VALUES(888665555, 20, NULL)

INSERT INTO company.[DEPENDENT] VALUES(333445555, 'Alice', 'F', '1986-04-05', 'Daughter')
INSERT INTO company.[DEPENDENT] VALUES(333445555, 'Theodore', 'M', '1983-10-25', 'Son')
INSERT INTO company.[DEPENDENT] VALUES(333445555, 'Joy', 'F', '1958-05-03', 'Spouse')
INSERT INTO company.[DEPENDENT] VALUES(987654321, 'Abner', 'M', '1942-02-28', 'Spouse')
INSERT INTO company.[DEPENDENT] VALUES(123456789, 'Michael', 'M', '1988-01-04', 'Son')
INSERT INTO company.[DEPENDENT] VALUES(123456789, 'Alice', 'F', '1988-12-30', 'Daughter')
INSERT INTO company.[DEPENDENT] VALUES(123456789, 'Elizabeth', 'F', '1967-05-05', 'Spouse')

SELECT * FROM company.DEPARTMENT
SELECT * FROM company.EMPLOYEE
SELECT * FROM company.DEPT_LOCATIONS
SELECT * FROM company.PROJECT
SELECT * FROM company.WORKS_ON
SELECT * FROM company.[DEPENDENT]

SELECT Fname, Lname
FROM company.EMPLOYEE
WHERE Dno = (SELECT TOP 1 Dno
			 FROM company.EMPLOYEE
			 ORDER BY Salary DESC)

SELECT Fname, Lname
FROM company.EMPLOYEE
WHERE Super_ssn = 888665555

CREATE VIEW company.[Department Managers] AS
SELECT Dname, Fname, Lname, Salary
FROM company.DEPARTMENT JOIN company.EMPLOYEE ON company.DEPARTMENT.Mgr_ssn = company.EMPLOYEE.Ssn
GO

SELECT * FROM company.[Department Managers]

CREATE VIEW company.[Research Department Employees] AS
SELECT A.Fname, A.Lname, A.Salary, B.Fname AS Mgr_Fname, B.Lname AS Mgr_Lname
FROM company.EMPLOYEE AS A JOIN company.EMPLOYEE AS B ON A.Super_ssn = B.Ssn
WHERE A.Dno = 5
GO

SELECT * FROM company.[Research Department Employees]

CREATE VIEW DEPT_SUMMARY (Dno, #_OF_EMPLOYEES_IN_DEPT, SALARY_SUM, AVG_SALARY) AS
(SELECT Dno, COUNT (*), SUM (Salary), AVG (Salary)
FROM company.EMPLOYEE
GROUP BY Dno);

SELECT *
FROM DEPT_SUMMARY

SELECT Dno, AVG_SALARY
FROM DEPT_SUMMARY
WHERE #_OF_EMPLOYEES_IN_DEPT >
(SELECT #_OF_EMPLOYEES_IN_DEPT
FROM DEPT_SUMMARY
WHERE Dno = 4);

UPDATE DEPT_SUMMARY
SET Dno = 3
WHERE Dno = 4;

DELETE FROM DEPT_SUMMARY
WHERE #_OF_EMPLOYEES_IN_DEPT > 4;